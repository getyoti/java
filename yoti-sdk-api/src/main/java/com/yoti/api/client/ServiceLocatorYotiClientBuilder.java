package com.yoti.api.client;

import java.io.IOException;
import java.util.ServiceLoader;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Build a YotiClient for an application and its corresponding key pair. You
 * only need to provide your SDK ID (provided by Yoti) and your
 * public-private key pair (generated by you or your browser).
 *
 */
final class ServiceLocatorYotiClientBuilder extends YotiClientBuilder implements YotiClientConfiguration {
    private static final Logger LOG = LoggerFactory.getLogger(ServiceLocatorYotiClientBuilder.class);
    private KeyPairSource keyPairSource;
    private String sdkId;

    @Deprecated
    @Override
    public YotiClientBuilder forApplication(String sdkId) {
        return withClientSdkId(sdkId);
    }

    @Override
    public YotiClientBuilder withClientSdkId(String sdkId) {
        this.sdkId = sdkId;
        return this;
    }

    @Override
    public YotiClientBuilder withKeyPair(KeyPairSource keyPairSource) throws IOException {
        this.keyPairSource = keyPairSource;
        return this;
    }

    @Override
    public YotiClient build() throws InitialisationException {
        checkBuilderState();

        ServiceLoader<YotiClientFactory> loader = ServiceLoader.load(YotiClientFactory.class);
        YotiClient result = null;
        for (YotiClientFactory client : loader) {
            if (client.accepts(sdkId)) {
                result = client.getInstance(this);
            }
        }
        if (result == null) {
            throw new IllegalStateException("No available clients found for application " + sdkId);
        } else {
            LOG.debug("Found Yoti client: {}", result.getClass().getName());
        }
        return result;
    }

    @Override
    public KeyPairSource getKeyPairSource() {
        return keyPairSource;
    }

    @Override
    public String getApplicationId() {
        return sdkId;
    }

    private void checkBuilderState() {
        if (keyPairSource == null) {
            throw new IllegalStateException("No key pair supplied");
        }
        if (sdkId == null) {
            throw new IllegalStateException("No SDK ID supplied");
        }
    }
}
